# docker-compose.yml (COMPLETO - Flask + MLflow + Airflow)

services:
  # ==========================================
  # MLFLOW
  # ==========================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: forecast_mlflow
    ports:
      - "5001:5000"
    command: >
      mlflow server
      --backend-store-uri file:///mlflow/mlruns
      --default-artifact-root /mlflow/artifacts
      --host 0.0.0.0
      --port 5000
    environment:
      # ðŸš€ Permite que outros containers (Flask, Airflow) acessem via "mlflow"
      - MLFLOW_SERVER_ALLOWED_HOSTS=*
      # (opcional) libera CORS se quiser acessar via browser
      - MLFLOW_SERVER_CORS_ALLOWED_ORIGINS=*
    volumes:
      - mlflow_data:/mlflow
    networks:
      - forecast_network
    restart: unless-stopped

  # ==========================================
  # AIRFLOW INIT
  # ==========================================
  airflow-init:
    image: apache/airflow:2.7.1-python3.9
    container_name: forecast_airflow_init
    entrypoint: /bin/bash
    command: >
      -c "pip install --no-cache-dir psycopg2-binary pyodbc prophet xgboost &&
          airflow db init &&
          airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com"
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://postgres:postgres@host.docker.internal:5432/airflow
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
    networks:
      - forecast_network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ==========================================
  # AIRFLOW WEBSERVER
  # ==========================================
  airflow-webserver:
    image: apache/airflow:2.7.1-python3.9
    container_name: forecast_airflow_webserver
    command: webserver
    ports:
      - "8080:8080"
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://postgres:postgres@host.docker.internal:5432/airflow
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - POSTGRES_CONNECTION_STRING=postgresql://postgres:postgres@host.docker.internal:5432/boxcompras
    volumes:
      - ./dags:/opt/airflow/dags
      - ./app:/opt/airflow/app
      - airflow_logs:/opt/airflow/logs
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      mlflow:
        condition: service_started
    networks:
      - forecast_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # ==========================================
  # AIRFLOW SCHEDULER
  # ==========================================
  airflow-scheduler:
    image: apache/airflow:2.7.1-python3.9
    container_name: forecast_airflow_scheduler
    command: scheduler
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://postgres:postgres@host.docker.internal:5432/airflow
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - POSTGRES_CONNECTION_STRING=postgresql://postgres:postgres@host.docker.internal:5432/boxcompras
    volumes:
      - ./dags:/opt/airflow/dags
      - ./app:/opt/airflow/app
      - airflow_logs:/opt/airflow/logs
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      mlflow:
        condition: service_started
    networks:
      - forecast_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # ==========================================
  # FLASK APP
  # ==========================================
  flask-app:
    build: .
    container_name: forecast_flask
    ports:
      - "5002:5002"
    environment:
      - POSTGRES_CONNECTION_STRING=postgresql://postgres:postgres@host.docker.internal:5432/boxcompras
      - SQLSERVER_CONNECTION_STRING=DRIVER={FreeTDS};SERVER=seu_servidor_ip;PORT=1433;DATABASE=pegasus;UID=seu_usuario;PWD=sua_senha;TDS_Version=8.0;
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MLFLOW_ENABLED=True
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5002
      - FLASK_DEBUG=True
      - GIT_PYTHON_REFRESH=quiet
    volumes:
      - ./app:/app/app
      - ./templates:/app/templates
      - ./static:/app/static
      - ./run.py:/app/run.py
    depends_on:
      - mlflow
    networks:
      - forecast_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    command: python run.py

volumes:
  mlflow_data:
  airflow_logs:

networks:
  forecast_network:
    driver: bridge